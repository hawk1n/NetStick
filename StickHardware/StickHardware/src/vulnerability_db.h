#ifndef VULNERABILITY_DB_H
#define VULNERABILITY_DB_H

#include "port_scanner.h"

// ============================================================================
// Vulnerability Database - CVE and security checks
// ============================================================================

// Vulnerability severity levels
enum VulnSeverity
{
    VULN_INFO = 1,     // Informational
    VULN_LOW = 3,      // Low risk
    VULN_MEDIUM = 5,   // Medium risk
    VULN_HIGH = 7,     // High risk
    VULN_CRITICAL = 10 // Critical
};

struct Vulnerability
{
    const char *cve;         // CVE identifier or custom ID
    const char *service;     // Affected service
    const char *version;     // Affected version (if applicable)
    int severity;            // 1-10 scale
    const char *description; // Human-readable description
    const char *remediation; // Suggested fix
};

struct VulnCheckResult
{
    bool found;
    Vulnerability vuln;
};

// Callback for vulnerability found
typedef void (*VulnFoundCallback)(const Vulnerability &vuln, uint16_t port);

class VulnerabilityDB
{
public:
    void init();

    // Analyze port scan results for vulnerabilities
    // Returns number of vulnerabilities found
    int analyzeService(const PortResult &portResult, VulnFoundCallback callback = nullptr);

    // Analyze all open ports
    int analyzeAllPorts(PortScanner &scanner, VulnFoundCallback callback = nullptr);

    // Check for specific vulnerabilities
    bool checkOpenTelnet(uint16_t port);
    bool checkOpenFTP(uint16_t port, const char *banner);
    bool checkOldSSH(const char *banner);
    bool checkOldApache(const char *banner);
    bool checkOldNginx(const char *banner);
    bool checkDefaultPorts(uint16_t port);

    // Get results
    int getVulnCount() const { return vulnCount; }
    int getMaxSeverity() const { return maxSeverity; }
    Vulnerability getVuln(int index) const;

private:
    static const int MAX_VULNS = 10; // increased to track more issues
    Vulnerability foundVulns[MAX_VULNS];
    int vulnCount = 0;
    int maxSeverity = 0;

    void addVuln(const Vulnerability &vuln, VulnFoundCallback callback, uint16_t port);
    bool extractVersion(const char *banner, const char *product, char *version, size_t versionSize);
    int compareVersions(const char *v1, const char *v2);
};

extern VulnerabilityDB vulnDB;

#endif // VULNERABILITY_DB_H
