#include "vulnerability_db.h"
#include <cstring>

// Lightweight no-op vulnerability DB to save flash

VulnerabilityDB vulnDB;

void VulnerabilityDB::init()
{
    vulnCount = 0;
    maxSeverity = 0;
}

void VulnerabilityDB::addVuln(const Vulnerability &vuln, VulnFoundCallback callback, uint16_t port)
{
    if (vulnCount >= MAX_VULNS)
        return;
    foundVulns[vulnCount++] = vuln;
    if (vuln.severity > maxSeverity)
        maxSeverity = vuln.severity;
    if (callback)
        callback(vuln, port);
}

bool VulnerabilityDB::extractVersion(const char *banner, const char *product, char *version, size_t versionSize)
{
    // Minimal stub: no version parsing to keep binary small
    if (versionSize > 0)
        version[0] = '\0';
    (void)banner;
    (void)product;
    return false;
}

int VulnerabilityDB::compareVersions(const char *v1, const char *v2)
{
    (void)v1;
    (void)v2;
    return 0;
}

bool VulnerabilityDB::checkOpenTelnet(uint16_t port) { return port == 23; }
bool VulnerabilityDB::checkOpenFTP(uint16_t port, const char *banner)
{
    (void)banner;
    return port == 21;
}
bool VulnerabilityDB::checkOldSSH(const char *banner)
{
    (void)banner;
    return false;
}
bool VulnerabilityDB::checkOldApache(const char *banner)
{
    (void)banner;
    return false;
}
bool VulnerabilityDB::checkOldNginx(const char *banner)
{
    (void)banner;
    return false;
}
bool VulnerabilityDB::checkDefaultPorts(uint16_t port)
{
    switch (port)
    {
    case 3306:
    case 5432:
    case 6379:
    case 445:
    case 3389:
        return true;
    default:
        return false;
    }
}

int VulnerabilityDB::analyzeService(const PortResult &portResult, VulnFoundCallback callback)
{
    if (!portResult.open)
        return 0;

    int start = vulnCount;

    // Check for Telnet (unencrypted remote access)
    if (checkOpenTelnet(portResult.port))
    {
        Vulnerability vuln = {
            "TELNET-EXPOSURE",
            "Telnet",
            "any",
            VULN_HIGH,
            "Unencrypted remote access - credentials transmitted in clear text",
            "Disable Telnet, use SSH instead"
        };
        addVuln(vuln, callback, portResult.port);
    }

    // Check for FTP (unencrypted file transfer)
    if (checkOpenFTP(portResult.port, portResult.banner))
    {
        Vulnerability vuln = {
            "FTP-EXPOSURE",
            "FTP",
            "any",
            VULN_MEDIUM,
            "Unencrypted file transfer protocol",
            "Use SFTP or FTPS instead"
        };
        addVuln(vuln, callback, portResult.port);
    }

    // Check for exposed databases
    if (portResult.port == 3306)
    {
        Vulnerability vuln = {
            "MYSQL-EXPOSED",
            "MySQL",
            "any",
            VULN_HIGH,
            "Database port exposed to network",
            "Restrict access with firewall rules"
        };
        addVuln(vuln, callback, portResult.port);
    }
    else if (portResult.port == 5432)
    {
        Vulnerability vuln = {
            "POSTGRES-EXPOSED",
            "PostgreSQL",
            "any",
            VULN_HIGH,
            "Database port exposed to network",
            "Restrict access with firewall rules"
        };
        addVuln(vuln, callback, portResult.port);
    }
    else if (portResult.port == 6379)
    {
        Vulnerability vuln = {
            "REDIS-EXPOSED",
            "Redis",
            "any",
            VULN_CRITICAL,
            "Redis cache exposed - often lacks authentication",
            "Enable authentication and restrict access"
        };
        addVuln(vuln, callback, portResult.port);
    }
    else if (portResult.port == 27017)
    {
        Vulnerability vuln = {
            "MONGODB-EXPOSED",
            "MongoDB",
            "any",
            VULN_CRITICAL,
            "Database exposed - may lack authentication",
            "Enable authentication and restrict access"
        };
        addVuln(vuln, callback, portResult.port);
    }

    // Check for SMB/RDP
    if (portResult.port == 445)
    {
        Vulnerability vuln = {
            "SMB-EXPOSED",
            "SMB",
            "any",
            VULN_HIGH,
            "SMB file sharing exposed - vulnerable to ransomware",
            "Restrict SMB access to trusted networks"
        };
        addVuln(vuln, callback, portResult.port);
    }
    else if (portResult.port == 3389)
    {
        Vulnerability vuln = {
            "RDP-EXPOSED",
            "RDP",
            "any",
            VULN_HIGH,
            "Remote Desktop exposed - brute force target",
            "Use VPN or disable public RDP access"
        };
        addVuln(vuln, callback, portResult.port);
    }

    // Check for VNC
    if (portResult.port >= 5900 && portResult.port <= 5999)
    {
        Vulnerability vuln = {
            "VNC-EXPOSED",
            "VNC",
            "any",
            VULN_MEDIUM,
            "VNC remote access exposed",
            "Use strong passwords and VPN access"
        };
        addVuln(vuln, callback, portResult.port);
    }

    // Check banners for version information
    if (portResult.banner[0] != '\0')
    {
        // Check for old SSH versions
        if (strstr(portResult.banner, "SSH-1.") != nullptr)
        {
            Vulnerability vuln = {
                "CVE-2001-0572",
                "SSH",
                "1.x",
                VULN_CRITICAL,
                "SSH v1 protocol vulnerable to MITM attacks",
                "Upgrade to SSH v2"
            };
            addVuln(vuln, callback, portResult.port);
        }

        // Check for Apache versions with known vulnerabilities
        if (strstr(portResult.banner, "Apache/2.4.49") || strstr(portResult.banner, "Apache/2.4.50"))
        {
            Vulnerability vuln = {
                "CVE-2021-41773",
                "Apache HTTP Server",
                "2.4.49-2.4.50",
                VULN_CRITICAL,
                "Path traversal and RCE vulnerability",
                "Upgrade to Apache 2.4.51 or later"
            };
            addVuln(vuln, callback, portResult.port);
        }

        // Check for older nginx versions
        if (strstr(portResult.banner, "nginx/1.14") || strstr(portResult.banner, "nginx/1.15"))
        {
            Vulnerability vuln = {
                "NGINX-OLD-VERSION",
                "nginx",
                "1.14-1.15",
                VULN_MEDIUM,
                "Outdated nginx version - upgrade to latest stable",
                "Update nginx packages"
            };
            addVuln(vuln, callback, portResult.port);
        }

        // Check for vsftpd backdoor
        if (strstr(portResult.banner, "vsftpd 2.3.4"))
        {
            Vulnerability vuln = {
                "CVE-2011-2523",
                "vsftpd",
                "2.3.4",
                VULN_CRITICAL,
                "Backdoor in vsftpd 2.3.4 allows remote code execution",
                "Upgrade vsftpd immediately"
            };
            addVuln(vuln, callback, portResult.port);
        }

        // Check for weak SSH versions
        if (strstr(portResult.banner, "OpenSSH_5.") || strstr(portResult.banner, "OpenSSH_6.") || strstr(portResult.banner, "OpenSSH_7.2"))
        {
            Vulnerability vuln = {
                "SSH-OLD-VERSION",
                "OpenSSH",
                "legacy",
                VULN_HIGH,
                "Outdated SSH version with known vulnerabilities",
                "Upgrade OpenSSH to a supported release"
            };
            addVuln(vuln, callback, portResult.port);
        }
    }

    return vulnCount - start;
}

int VulnerabilityDB::analyzeAllPorts(PortScanner &scanner, VulnFoundCallback callback)
{
    int start = vulnCount;
    for (int i = 0; i < scanner.getOpenPortCount(); ++i)
    {
        analyzeService(scanner.getResult(i), callback);
    }
    return vulnCount - start;
}

Vulnerability VulnerabilityDB::getVuln(int index) const
{
    if (index < 0 || index >= vulnCount)
    {
        static Vulnerability empty = {nullptr, nullptr, nullptr, 0, nullptr, nullptr};
        return empty;
    }
    return foundVulns[index];
}
